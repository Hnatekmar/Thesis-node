!function(t){var e={};function o(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=t,o.c=e,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=4)}([function(t,e){t.exports=require("p2")},function(t,e){t.exports=require("ces")},function(t,e){t.exports=require("chance")},function(t,e){t.exports=require("lodash")},function(t,e,o){o(5);var n=o(6),i=o(3),r=(o(7),o(8)),s=o(9),a={driver:"sqlite3",database:"database.sqlite3"},l=new(0,o(10).Schema)(a.driver,a),h=o(11)(l);h.destroyAll();var c=s.cpus().length,u=new n.Neat(37,6,null,{popsize:256*c,mutation:n.methods.mutation.ALL,mutationRate:.25,network:new n.architect.Random(37,256,6)});Number.MIN_VALUE;if(r.isMaster){for(var d=[],p=0,f=0;f<c;f++)d.push(r.fork());for(var y=0;y<c;y++)d[y].on("message",function(t){p+=1,u.population[t.index].score=t.score});i.chunk(u.population,u.population.length/d.length).forEach(function(t,e){var o=t.map(function(t){return t.toJSON()});d[e].send({json:o,index:Math.floor(e*(u.population.length/d.length))})}),setInterval(function(){p===u.population.length&&(!function(){u.sort(),console.log("Generation "+u.generation);for(var t=[],e=0;e<u.elitism;e++)t.push(u.population[e]);for(var o=0;o<u.popsize-u.elitism;o++)t.push(u.getOffspring());for(var n in u.population){var i=u.population[n].toJSON();new h({genome:i,fitness:u.population[n].score,generation:u.generation}).save()}delete u.population,u.population=t,u.mutate(),u.generation++}(),p=0,i.chunk(u.population,u.population.length/d.length).forEach(function(t,e){var o=t.map(function(t){return t.toJSON()});d[e].send({json:o,index:Math.floor(e*(u.population.length/d.length))})}))},100)}else{var g=new(0,o(13).default)(60);process.on("message",function(t){for(var e=0;e<t.json.length;e++){var o=n.Network.fromJSON(t.json[e]),i=g.evalGenome(1/30,o);process.send({score:i,index:t.index+e})}})}},function(t,e){t.exports=require("async")},function(t,e){t.exports=require("neataptic")},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("cluster")},function(t,e){t.exports=require("os")},function(t,e){t.exports=require("caminte")},function(t,e){t.exports=function(t){return t.define("genome",{id:{type:t.Integer},genome:{type:t.Json},fitness:{type:t.Float},generation:{type:t.Integer},saveTime:{type:t.Date,default:Date.now}},{primaryKeys:["id"]})}},function(t,e){t.exports=require("assert")},function(t,e,o){"use strict";o.r(e);var n=o(1),i=o(0),r=n.System.extend({addedToWorld:function(t){var e=this;this._super(t),this.p2World=new i.World({gravity:[0,0]}),t.entityAdded("physics").add(function(t){var o=t.getComponent("physics");o.world=e.p2World,e.p2World.addBody(o.body)}),t.entityRemoved("physics").add(function(t){e.p2World.removeBody(t.getComponent("physics").body)})},update:function(t){this.p2World.step(1/30,t,20)}});function s(t){for(var e=-1,o=-1,n=0;n<t.length;n++)t[n]>o&&(o=t[n],e=n);return e}var a=n.System.extend({update:function(t){var e=this;this.world.getEntities("car").forEach(function(t){var o=t.getComponent("car"),n=o.chassis.getComponent("physics").body;if(void 0===n.callbackInitialized&&(n.world.on("beginContact",function(t){var e=t.bodyA,r=t.bodyB;n.sleepState!==i.Body.SLEEPING&&(o.fitness-=5e4),e.id!==n.id&&r.id!==n.id||(n.allowSleep=!0,n.force=[0,0],n.sleep())}),n.callbackInitialized=!0),void 0===e.input){e.input=[];for(var r=0;r<=o.sensors.length;r++)e.input.push(0);o.backWheel.setBrakeForce(0),o.frontWheel.setBrakeForce(0),o.frontWheel.setSideFriction(8e3),o.backWheel.setSideFriction(6e3)}for(var a=0;a<o.sensors.length;a++)o.sensors[a].cast(n.position,[n.id],n.angle),(o.sensors[a].shortest.distance===1/0||o.sensors[a].shortest.distance>800)&&(o.sensors[a].shortest.distance=800),o.sensors[a].shortest.distance/=800,e.input[a]=o.sensors[a].shortest.distance;e.input[o.sensors.length-1]=n.angle;var l=Math.sqrt(i.vec2.squaredLength(n.velocity));if(0===l&&0!==o.fitness&&(n.allowSleep=!0,n.force=[0,0],n.sleep()),n.sleepState!==i.Body.SLEEPING){for(var h=o.genome.activate(e.input),c=isNaN(l),u=0;u<h.length;u++)if(c||isNaN(h[u]))return h[u]=0,o.fitness=-9e6,n.allowSleep=!0,n.force=[0,0],void n.sleep();var d=s(h.slice(0,3)),p=s(h.slice(4,6)),f=0;0===p?(f=-1,o.fitness+=l):1===p?(f=.15,o.fitness+=.5*l):2===p&&(0===l&&(n.allowSleep=!0,n.force=[0,0],n.sleep()),f=0,o.fitness-=100,o.frontWheel.setBrakeForce(1e4)),0===d?o.frontWheel.steerValue>5/6*Math.PI&&(o.frontWheel.steerValue-=Math.PI/180*10):1===d&&o.frontWheel.steerValue<Math.PI/6&&(o.frontWheel.steerValue+=Math.PI/180*10),o.backWheel.engineForce=7*f*9e3}})}}),l=n.Component.extend({name:"physics",init:function(t){this.body=t}}),h=n.Component.extend({name:"car",force:0,init:function(t,e,o,n,i){this.genome=e,this.chassis=t,this.car=o,this.fitness=0,this.frontWheel=n,this.backWheel=i},getAngle:function(t,e){return e<t.angleFrom&&(e=t.angleFrom),e>t.angleTo&&(e=t.angleTo),e},steer:function(t){var e=this;this.wheels.forEach(function(o){o.angle=e.getAngle(o,t)})}}),c=o(3);function u(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var d=function(){function t(e,o){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.endPoint=e,this.world=o,this.shortest=null,this.endPoint[0]*=800,this.endPoint[1]*=800;var r=this;this.shortest={distance:1/0},this.ray=new i.Ray({mode:i.Ray.ALL,from:r.origin,to:r.endPoint,callback:function(t){if(!r.ignoredIDs.includes(t.body.id)){var e=t.getHitDistance(r.ray);e<n.shortest.distance&&(r.shortest.distance=e,r.shortest.body=t.body)}}})}return function(t,e,o){e&&u(t.prototype,e),o&&u(t,o)}(t,[{key:"cast",value:function(t,e,o){var n=[0,0];i.vec2.rotate(n,this.endPoint,o);var r=[0,0];r[0]=t[0]+n[0],r[1]=t[1]+n[1],this.ignoredIDs=e,this.calculateShortest(t,r)}},{key:"calculateShortest",value:function(t,e){this.ray.from=t,this.ray.to=e,this.ray.update();var o=new i.RaycastResult;this.world.raycast(o,this.ray)}}]),t}(),p=function(t,e,o,r,s){var a=new n.Entity,h=new i.Body({mass:0,position:[t,e]});return h.addShape(new i.Box({width:o,height:r})),a.addComponent(new l(h)),s.addEntity(a),a};function f(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var y=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),o(12)(e instanceof Array),this.bodies=e,this.bodies.forEach(function(t){t.oldOrigin=t.body.position.slice(0)})}return function(t,e,o){e&&f(t.prototype,e),o&&f(t,o)}(t,[{key:"move",value:function(t,e){this.bodies.forEach(function(o){o.body.position[0]+=t,o.body.position[1]+=e})}},{key:"moveAbsolute",value:function(t,e){this.bodies.forEach(function(t){t.body.position=t.oldOrigin.slice(0)}),this.move(t,e)}}]),t}(),g=function(t,e,o,n){var i=n.map(function(t){return t.getComponent("physics")});return new y(i)},v=o(2),m=o.n(v);var w=n.System.extend({setWorld:function(t){var e=this;this.world=t,this.rng=new m.a("RNG0,0"),this.position=[0,0],this.parts={"-":{group:g(0,0,this.world,[p(0,250,8e3,20,this.world),p(0,550,8e3,20,this.world)]),possibleParts:{left:["Cross","T"],right:["Cross","T"]}},I:{group:g(0,0,this.world,[p(250,0,20,8e3,this.world),p(550,0,20,8e3,this.world)]),possibleParts:{up:["Cross","I"],down:["Cross","T","I"]}},T:{group:g(0,0,this.world,[p(250,700,20,400,this.world),p(550,700,20,400,this.world),p(125,500,250,20,this.world),p(675,500,250,20,this.world),p(400,250,800,20,this.world)]),possibleParts:{down:["Cross","I"],up:["Cross","I"],left:["Cross","T"],right:["Cross","T"]}},Cross:{group:g(0,0,this.world,[p(675,500,250,20,this.world),p(125,500,250,20,this.world),p(675,250,250,20,this.world),p(125,250,250,20,this.world),p(250,50,20,400,this.world),p(550,50,20,400,this.world),p(250,700,20,400,this.world),p(550,700,20,400,this.world)]),possibleParts:{up:["Cross","I"],down:["Cross","T","I"],left:["Cross","T"],right:["Cross","T"]}},Box:{group:g(0,0,this.world,[p(400,0,800,20,this.world),p(0,400,20,800,this.world),p(800,400,20,800,this.world),p(400,800,800,20,this.world)]),possibleParts:{}}},Object.keys(this.parts).forEach(function(t){"Box"!==t&&e.parts[t].group.moveAbsolute(5e4*Math.sin(Math.random()),5e4*Math.cos(Math.random()))})},reset:function(){this.rng=new m.a("RNG0,0"),this.position=[0,0],this.currentPart.group.moveAbsolute(5e4*Math.sin(Math.random()),5e4*Math.cos(Math.random())),this.currentPart=this.parts.Box,this.currentPart.group.moveAbsolute(0,0)},setCar:function(t){this.car=t},getCarPosition:function(){return null!=this.car?this.car.getComponent("physics").body.position:null},swapNextRoadPart:function(t){if(void 0!==this.currentPart){var e=this.currentPart.possibleParts[t];0!==e.length&&("up"===t&&(this.position[1]+=1),"down"===t&&(this.position[1]-=1),"left"===t&&(this.position[0]-=1),"right"===t&&(this.position[0]+=1),this.currentPart.group.moveAbsolute(5e4,5e4),this.rng=new m.a("RNG"+this.position[0]+","+this.position[1]),0===this.position[0]&&0===this.position[1]?this.currentPart=this.parts.Box:this.currentPart=this.parts[this.rng.pickone(e)],this.currentPart.group.moveAbsolute(0,0),this.moveCarBackToScreen(t))}},moveCarBackToScreen:function(t){var e=this.car.getComponent("physics").body;this.car.getComponent("car").fitness+=500;var o=[0,0];"up"===t?o=[e.position[0],0]:"down"===t?o=[e.position[0],800]:"left"===t?o=[800,e.position[1]]:"right"===t&&(o=[0,e.position[1]]),e.position=o},update:function(t){void 0===this.currentPart&&(this.currentPart=this.parts.Box);var e=this.getCarPosition();if(null!==e){var o=function(t,e,o,n){return t>=o?"right":e>=n?"up":t<=0?"left":e<=0?"down":"onScreen"}(e[0],e[1],800,800);"onScreen"!==o&&this.swapNextRoadPart(o)}}});function b(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}o.d(e,"default",function(){return C});var P=o(1);var C=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.time=e}return function(t,e,o){e&&b(t.prototype,e),o&&b(t,o)}(t,[{key:"init",value:function(){void 0===this.world?(this.world=new P.World,this.physicsSystem=new r,this.world.addSystem(this.physicsSystem),this.world.addSystem(new a),this.car=function(t,e,o,r){var s=new n.Entity,a=new i.Body({mass:2e3,position:[t,e],allowSleep:!1});a.addShape(new i.Box({width:100,height:200})),s.addComponent(new l(a));var u=new i.TopDownVehicle(a),p=u.addWheel({localPosition:[0,100]}),f=u.addWheel({localPosition:[0,-100]});s.addComponent(new h(s,r,u,p,f)),o.addEntity(s);var y=s.getComponent("car"),g=s.getComponent("physics").world;return u.addToWorld(g),y.sensors=c.range(0,360,10).map(function(t){return new d([Math.cos(t*(Math.PI/180)),Math.sin(t*(Math.PI/180))],g)}),s}(400,400,this.world,this.genome),this.roadDirector=new w,this.roadDirector.setWorld(this.world),this.roadDirector.setCar(this.car),this.world.addSystem(this.roadDirector)):this.car.getComponent("car").genome=this.genome,this.lastDt=0}},{key:"evaluate",value:function(t){this.destroy(),this.genome=t,this.init(),this.acc=0,this.lastDt=null;var e=this;return new Promise(function(t){e.onFinish=t})}},{key:"evalGenome",value:function(t,e){this.destroy(),this.genome=e,this.init(),this.acc=0,this.lastDt=null;for(var o=0;this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==i.Body.SLEEPING;)o=this.update(t);return o}},{key:"update",value:function(t){return null===this.lastDt&&(this.lastDt=t),this.acc+=t,this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==i.Body.SLEEPING&&this.world.update(t),this.car.getComponent("car").fitness}},{key:"destroy",value:function(){if(void 0!==this.world){this.car.getComponent("car").fitness=0;var t=this.car.getComponent("physics").body;t.allowSleep=!1,t.sleepState===i.Body.SLEEPING&&t.wakeUp(),t.setZeroForce(),t.position=[this.position[0],this.position[1]],t.angularVelocity=0,t.velocity=[0,0],t.angle=0,this.roadDirector.reset()}else this.position=[400,400],this.velocity=[0,0]}}]),t}()}]);