!function(t){var e={};function o(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=t,o.c=e,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=4)}([function(t,e){t.exports=require("p2")},function(t,e){t.exports=require("ces")},function(t,e){t.exports=require("chance")},function(t,e){t.exports=require("lodash")},function(t,e,o){o(5);var n=o(6),i=o(3),s=o(7),r=o(8),a=o(9),l=new n.Neat(37,6,null,{popsize:128*(a.cpus().length-1),mutation:n.methods.mutation.ALL,mutationRate:.25,network:new n.architect.Random(37,128,6)}),c=Number.MIN_VALUE;if(r.isMaster){for(var h=[],u=0,d=0;d<a.cpus().length-1;d++)h.push(r.fork());for(var p=0;p<a.cpus().length-1;p++)h[p].on("message",function(t){u+=1,l.population[t.index].score=t.score});i.chunk(l.population,l.population.length/h.length).forEach(function(t,e){var o=t.map(function(t){return t.toJSON()});h[e].send({json:o,index:Math.floor(e*(l.population.length/h.length))})}),setInterval(function(){u===l.population.length&&(!function(){l.sort(),console.log("Generation "+l.generation);for(var t=[],e=0;e<l.elitism;e++)t.push(l.population[e]);for(var o=0;o<l.popsize-l.elitism;o++)t.push(l.getOffspring());var n=l.getFittest().score;if(console.log(n),n>c){c=n,console.log("Saving best specimen");var i=JSON.stringify(l.getFittest().toJSON());s.writeFileSync("best.json",i)}delete l.population,l.population=t,l.mutate(),l.generation++}(),u=0,i.chunk(l.population,l.population.length/h.length).forEach(function(t,e){var o=t.map(function(t){return t.toJSON()});h[e].send({json:o,index:Math.floor(e*(l.population.length/h.length))})}))},100)}else{var f=new(0,o(11).default)(60);process.on("message",function(t){for(var e=0;e<t.json.length;e++){var o=n.Network.fromJSON(t.json[e]),i=f.evalGenome(.5,o);process.send({score:i,index:t.index+e})}})}},function(t,e){t.exports=require("async")},function(t,e){t.exports=require("neataptic")},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("cluster")},function(t,e){t.exports=require("os")},function(t,e){t.exports=require("assert")},function(t,e,o){"use strict";o.r(e);var n=o(1),i=o(0),s=n.System.extend({addedToWorld:function(t){var e=this;this._super(t),this.p2World=new i.World({gravity:[0,0]}),t.entityAdded("physics").add(function(t){var o=t.getComponent("physics");o.world=e.p2World,e.p2World.addBody(o.body)}),t.entityRemoved("physics").add(function(t){e.p2World.removeBody(t.getComponent("physics").body)})},update:function(t){this.p2World.step(1/30,t,20)}});function r(t){for(var e=-1,o=-1,n=0;n<t.length;n++)t[n]>o&&(o=t[n],e=n);return e}var a=n.System.extend({update:function(t){var e=this;this.world.getEntities("car").forEach(function(t){var o=t.getComponent("car"),n=o.chassis.getComponent("physics").body;if(void 0===n.callbackInitialized&&(n.world.on("beginContact",function(t){var e=t.bodyA,s=t.bodyB;n.sleepState!==i.Body.SLEEPING&&(o.fitness-=5e4),e.id!==n.id&&s.id!==n.id||(n.allowSleep=!0,n.force=[0,0],n.sleep())}),n.callbackInitialized=!0),void 0===e.input){e.input=[];for(var s=0;s<=o.sensors.length;s++)e.input.push(0);o.backWheel.setBrakeForce(0),o.frontWheel.setBrakeForce(0),o.frontWheel.setSideFriction(8e3),o.backWheel.setSideFriction(6e3)}for(var a=0;a<o.sensors.length;a++)o.sensors[a].cast(n.position,[n.id],n.angle),(o.sensors[a].shortest.distance===1/0||o.sensors[a].shortest.distance>800)&&(o.sensors[a].shortest.distance=800),o.sensors[a].shortest.distance/=800,e.input[a]=o.sensors[a].shortest.distance;e.input[o.sensors.length-1]=n.angle;var l=Math.sqrt(i.vec2.squaredLength(n.velocity));if(0===l&&0!==o.fitness&&(n.allowSleep=!0,n.force=[0,0],n.sleep()),n.sleepState!==i.Body.SLEEPING){for(var c=o.genome.activate(e.input),h=isNaN(l),u=0;u<c.length;u++)if(h||isNaN(c[u]))return c[u]=0,o.fitness=-9e6,n.allowSleep=!0,n.force=[0,0],void n.sleep();var d=r(c.slice(0,3)),p=r(c.slice(4,6)),f=0;0===p?(f=-1,o.fitness+=l):1===p?(f=.15,o.fitness+=.5*l):2===p&&(0===l&&(n.allowSleep=!0,n.force=[0,0],n.sleep()),f=0,o.fitness-=100,o.frontWheel.setBrakeForce(1e4)),0===d?o.frontWheel.steerValue>5/6*Math.PI&&(o.frontWheel.steerValue-=Math.PI/180*10):1===d&&o.frontWheel.steerValue<Math.PI/6&&(o.frontWheel.steerValue+=Math.PI/180*10),o.backWheel.engineForce=7*f*9e3}})}}),l=n.Component.extend({name:"physics",init:function(t){this.body=t}}),c=n.Component.extend({name:"car",force:0,init:function(t,e,o,n,i){this.genome=e,this.chassis=t,this.car=o,this.fitness=0,this.frontWheel=n,this.backWheel=i},getAngle:function(t,e){return e<t.angleFrom&&(e=t.angleFrom),e>t.angleTo&&(e=t.angleTo),e},steer:function(t){var e=this;this.wheels.forEach(function(o){o.angle=e.getAngle(o,t)})}}),h=o(3);function u(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var d=function(){function t(e,o){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.endPoint=e,this.world=o,this.shortest=null,this.endPoint[0]*=800,this.endPoint[1]*=800;var s=this;this.shortest={distance:1/0},this.ray=new i.Ray({mode:i.Ray.ALL,from:s.origin,to:s.endPoint,callback:function(t){if(!s.ignoredIDs.includes(t.body.id)){var e=t.getHitDistance(s.ray);e<n.shortest.distance&&(s.shortest.distance=e,s.shortest.body=t.body)}}})}return function(t,e,o){e&&u(t.prototype,e),o&&u(t,o)}(t,[{key:"cast",value:function(t,e,o){var n=[0,0];i.vec2.rotate(n,this.endPoint,o);var s=[0,0];s[0]=t[0]+n[0],s[1]=t[1]+n[1],this.ignoredIDs=e,this.calculateShortest(t,s)}},{key:"calculateShortest",value:function(t,e){this.ray.from=t,this.ray.to=e,this.ray.update();var o=new i.RaycastResult;this.world.raycast(o,this.ray)}}]),t}(),p=function(t,e,o,s,r){var a=new n.Entity,c=new i.Body({mass:0,position:[t,e]});return c.addShape(new i.Box({width:o,height:s})),a.addComponent(new l(c)),r.addEntity(a),a};function f(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var g=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),o(10)(e instanceof Array),this.bodies=e,this.bodies.forEach(function(t){t.oldOrigin=t.body.position.slice(0)})}return function(t,e,o){e&&f(t.prototype,e),o&&f(t,o)}(t,[{key:"move",value:function(t,e){this.bodies.forEach(function(o){o.body.position[0]+=t,o.body.position[1]+=e})}},{key:"moveAbsolute",value:function(t,e){this.bodies.forEach(function(t){t.body.position=t.oldOrigin.slice(0)}),this.move(t,e)}}]),t}(),y=function(t,e,o,n){var i=n.map(function(t){return t.getComponent("physics")});return new g(i)},v=o(2),w=o.n(v);var m=n.System.extend({setWorld:function(t){var e=this;this.world=t,this.rng=new w.a("RNG0,0"),this.position=[0,0],this.parts={"-":{group:y(0,0,this.world,[p(0,250,8e3,20,this.world),p(0,550,8e3,20,this.world)]),possibleParts:{left:["Cross","T"],right:["Cross","T"]}},I:{group:y(0,0,this.world,[p(250,0,20,8e3,this.world),p(550,0,20,8e3,this.world)]),possibleParts:{up:["Cross","I"],down:["Cross","T","I"]}},T:{group:y(0,0,this.world,[p(250,700,20,400,this.world),p(550,700,20,400,this.world),p(125,500,250,20,this.world),p(675,500,250,20,this.world),p(400,250,800,20,this.world)]),possibleParts:{down:["Cross","I"],up:["Cross","I"],left:["Cross","T"],right:["Cross","T"]}},Cross:{group:y(0,0,this.world,[p(675,500,250,20,this.world),p(125,500,250,20,this.world),p(675,250,250,20,this.world),p(125,250,250,20,this.world),p(250,50,20,400,this.world),p(550,50,20,400,this.world),p(250,700,20,400,this.world),p(550,700,20,400,this.world)]),possibleParts:{up:["Cross","I"],down:["Cross","T","I"],left:["Cross","T"],right:["Cross","T"]}},Box:{group:y(0,0,this.world,[p(400,0,800,20,this.world),p(0,400,20,800,this.world),p(800,400,20,800,this.world),p(400,800,800,20,this.world)]),possibleParts:{}}},Object.keys(this.parts).forEach(function(t){"Box"!==t&&e.parts[t].group.moveAbsolute(5e4*Math.sin(Math.random()),5e4*Math.cos(Math.random()))})},reset:function(){this.rng=new w.a("RNG0,0"),this.position=[0,0],this.currentPart.group.moveAbsolute(5e4*Math.sin(Math.random()),5e4*Math.cos(Math.random())),this.currentPart=this.parts.Box,this.currentPart.group.moveAbsolute(0,0)},setCar:function(t){this.car=t},getCarPosition:function(){return null!=this.car?this.car.getComponent("physics").body.position:null},swapNextRoadPart:function(t){if(void 0!==this.currentPart){var e=this.currentPart.possibleParts[t];0!==e.length&&("up"===t&&(this.position[1]+=1),"down"===t&&(this.position[1]-=1),"left"===t&&(this.position[0]-=1),"right"===t&&(this.position[0]+=1),this.currentPart.group.moveAbsolute(5e4,5e4),this.rng=new w.a("RNG"+this.position[0]+","+this.position[1]),0===this.position[0]&&0===this.position[1]?this.currentPart=this.parts.Box:this.currentPart=this.parts[this.rng.pickone(e)],this.currentPart.group.moveAbsolute(0,0),this.moveCarBackToScreen(t))}},moveCarBackToScreen:function(t){var e=this.car.getComponent("physics").body;this.car.getComponent("car").fitness+=500;var o=[0,0];"up"===t?o=[e.position[0],0]:"down"===t?o=[e.position[0],800]:"left"===t?o=[800,e.position[1]]:"right"===t&&(o=[0,e.position[1]]),e.position=o},update:function(t){void 0===this.currentPart&&(this.currentPart=this.parts.Box);var e=this.getCarPosition();if(null!==e){var o=function(t,e,o,n){return t>=o?"right":e>=n?"up":t<=0?"left":e<=0?"down":"onScreen"}(e[0],e[1],800,800);"onScreen"!==o&&this.swapNextRoadPart(o)}}});function b(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}o.d(e,"default",function(){return S});var P=o(1);var S=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.time=e}return function(t,e,o){e&&b(t.prototype,e),o&&b(t,o)}(t,[{key:"init",value:function(){void 0===this.world?(this.world=new P.World,this.physicsSystem=new s,this.world.addSystem(this.physicsSystem),this.world.addSystem(new a),this.car=function(t,e,o,s){var r=new n.Entity,a=new i.Body({mass:2e3,position:[t,e],allowSleep:!1});a.addShape(new i.Box({width:100,height:200})),r.addComponent(new l(a));var u=new i.TopDownVehicle(a),p=u.addWheel({localPosition:[0,100]}),f=u.addWheel({localPosition:[0,-100]});r.addComponent(new c(r,s,u,p,f)),o.addEntity(r);var g=r.getComponent("car"),y=r.getComponent("physics").world;return u.addToWorld(y),g.sensors=h.range(0,360,10).map(function(t){return new d([Math.cos(t*(Math.PI/180)),Math.sin(t*(Math.PI/180))],y)}),r}(400,400,this.world,this.genome),this.roadDirector=new m,this.roadDirector.setWorld(this.world),this.roadDirector.setCar(this.car),this.world.addSystem(this.roadDirector)):this.car.getComponent("car").genome=this.genome,this.lastDt=0}},{key:"evaluate",value:function(t){this.destroy(),this.genome=t,this.init(),this.acc=0,this.lastDt=null;var e=this;return new Promise(function(t){e.onFinish=t})}},{key:"evalGenome",value:function(t,e){this.destroy(),this.genome=e,this.init(),this.acc=0,this.lastDt=null;for(var o=0;this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==i.Body.SLEEPING;)o=this.update(t);return o}},{key:"update",value:function(t){return null===this.lastDt&&(this.lastDt=t),this.acc+=t,this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==i.Body.SLEEPING&&this.world.update(t),this.car.getComponent("car").fitness}},{key:"destroy",value:function(){if(void 0!==this.world){this.car.getComponent("car").fitness=0;var t=this.car.getComponent("physics").body;!function(t,e){function o(t){return isNaN(t)?e:t}var n=Object.keys(t);for(var i in n)if("number"==typeof t[n[i]]&&isNaN(t[n[i]]))t[n[i]]=e;else if(null!==t[n[i]]&&t[n[i]].constructor===Float32Array)for(var s=0;s<t[n[i]].length;s++)t[n[i]][s]=o(t[n[i]][s])}(t,0),t.allowSleep=!1,t.sleepState===i.Body.SLEEPING&&t.wakeUp(),t.setZeroForce(),t.position=[this.position[0],this.position[1]],t.angularVelocity=0,t.velocity=[0,0],t.angle=0,this.roadDirector.reset()}else this.position=[400,400],this.velocity=[0,0]}}]),t}()}]);